
= {lab_name}
:navtitle: Narrative
:imagesdir: ../assets/images
:numbered:


[.text-justify]
== Demo Platform (demo.redhat.com)

=== Catalog Item
* link:https://demo.redhat.com/catalog?search=event+driven&item=babylon-catalog-prod%2Fenterprise.event-driven-ansible.prod[Launch the Demo by accessing the Catalog Item in RHDP]

=== Demo Access
Upon ordering the demo environment, you will gain comprehensive access to a fully-fledged interface that hosts all the systems you can utilize. Pay close attention to how specific values populate as your new environment activates and transitions to operational status. Here is an illustrative example for your reference:


image::demo_access_details.png[Access Details, 60%]

== Event-Driven Ansible

=== Demo Introduction

In this demo, we're showcasing the adaptability and effectiveness of Event-Driven Ansible. While we are utilizing Red Hat OpenShift events as a trigger, remember to highlight that this tool's capabilities aren't limited to just OpenShift - it's designed to work effectively with any operational ecosystem your customer may have.

Showcase how Event-Driven Ansible can use events to initiate actions, demonstrating its ability to turn any event into an opportunity for intelligent automation. This isn't just automation; it's an efficient, event-driven response system that's compatible with any operational ecosystem.

Use real-world examples to illustrate how this tool can enhance their processes, making them more efficient, faster, and responsive. By the end of this demonstration, your customers should understand the competitive advantage and agility that adopting Event-Driven Ansible can bring to their operations in today's rapidly evolving digital landscape.


=== The Power of Event-Driven Ansible
Event-Driven Ansible offers an amalgamation of Ansible's versatility and the principles of event-driven architecture, making it a significant asset for any operational ecosystem.

In this demo, you will discover how Event-Driven Ansible can manage not just application deployments and scaling operations but also be utilized for daily tasks and swift troubleshooting. This platform efficiently transforms automation into a quick, proactive response mechanism across the entire ecosystem, which is tailored for your customer's specific business needs.

By leveraging Event-Driven Ansible, you can significantly enhance your customer's infrastructure recovery time. Whenever an issue arises, the system automatically triggers a predefined response, reducing the time spent manually diagnosing and resolving the problem. This automation not only speeds up recovery but also minimizes the risk of human error during the troubleshooting process.

Additionally, Event-Driven Ansible also helps streamline and automate routine tasks. This allows your customer to focus on strategic initiatives rather than getting bogged down in day-to-day operations. Tasks like system updates, user management, and routine maintenance can be automated, saving valuable time and resources.

During the demonstration, you'll provide a clear understanding of how Event-Driven Ansible helps achieve efficient, intelligent, and responsive automation. This not only helps in rapid issue resolution and infrastructure recovery but also in efficiently managing daily operations. By showcasing these capabilities, you can highlight the extensive benefits and potential applications of Event-Driven Ansible in their organization, thereby enhancing their operational efficiency and productivity.

=== Source Page
* link:https://source.redhat.com/groups/public/rhdp/rhdp_catalog_items/catalog_items_wiki/event_driven_ansible_with_openshift_demo[Click to Access Event-driven Ansible with OpenShift Demo Source Page]


== Understanding Rulebooks

=== The Backbone of Event Driven Ansible
Central to our demonstration today are *'Rulebooks.'* In the context of Event-Driven Ansible, a rulebook defines the guidelines that Ansible should follow in response to particular events or conditions. 

A rulebook is our strategic playbook, constituted of three fundamental components:

* *Sources:* The starting point of our automation journey, sources determine the event source we're utilizing. These are drawn from a plethora of source plugins, crafted to cater to a variety of use cases. As we continue to expand our portfolio, more sources will become available. As of now, we have several ready-to-use plugins, including webhooks, Kafka, Azure service bus, file changes, and alertmanager.

* *Rules:* Acting as the decision makers, rules set the conditions we're looking for within the chosen event source. If a condition is met, it can trigger a subsequent action, forming a critical link in our automation chain.

* *Actions:* The culmination of our process, actions decide what should transpire once a condition is fulfilled. A variety of actions are currently available, such as run_playbook, run_module, set_fact, post_event, and debug.

This rulebook, therefore, provides a comprehensive, customizable, and extensible blueprint for your automation processes, ensuring we cover the full spectrum from event sources to reactive actions.

=== The Business Benefits of Event-Driven Ansible
In the course of this demo, we will delve into the manifold business benefits you can achieve by implementing Event-Driven Ansible:

*Real-Time Responsiveness:* Automate responses to events, leading to quicker issue resolution and optimized resource utilization.

* *Increased Efficiency:* Reduce manual tasks, minimize errors, and bolster operational productivity.

* *Scalability and Flexibility:* Expand your automation capabilities in sync with your infrastructure, enabling a seamless adaptation to changing environments.

* *Intelligent Automation:* Utilize event data to make informed decisions, thereby optimizing resource usage.

* *Enhanced Reliability:* Ensure consistent and accurate task execution, thus reducing risks associated with human error.

* *Improved Compliance and Governance:* Enforce standards, track automated actions, and demonstrate compliance.

* *Rapid Innovation and Time-to-Market:* Accelerate service delivery and application deployment to respond more swiftly to market trends.

Integration with Existing Systems: Seamlessly integrate with your existing tools, systems, and APIs.

=== Conclusion: The Transformative Potential of Event-Driven Ansible

In this demonstration, you will see how Event-Driven Ansible serves as a catalyst, unlocking unprecedented levels of automation that boost efficiency, scalability, and reliability across any operational environment. So, gear up for a deep dive into the next generation of automation technology.

== Architecture

=== High Level Infrastructure Architecture

image::event_driven_ansible_architecture.jpg[Event-Driven Ansible Architecture, 50%]


=== Say Do

.Trigger Events
[width=100%,cols="^.5%,30%a,65%a",options="header"]
|====
| SR No ^.^| Say ^.^| Do

|{counter:srn}|
[.text-justify]
=== Lab 1 - EDA apply resource quota on namespace
[.text-justify]
In order to show demo, We need to open couple of browser tabs for-

* Vscode server 
* Ansible Automation Platform
** Automation Controller
** Event Driven Ansible
* [Optional] OpenShift Console

[.text-justify]
*demo.redhat.com* Info page contains all of the access details.

|*Action:*
[.text-justify]
.  Go to the info page click on VScode server link, use password provided in the table to login. 

+
image:vscode_login.jpg[VScode Login page, 95%]

.  Go to info page click on Ansible Automation Platform link, use username and password provided in the table to login. 

+
NOTE: Sometimes copying and pasting the password may not work. If you're unable to log in, try typing the password manually, character by character, as this might resolve the issue.

+
image:ac_login.jpg[Automation Controller Login page, 95%]


.  [Optionally] Go to info page click on OpenShift Console  link, use username and password provided in the table to login. 
+
.Click htpasswd_provider
image:oc_login_1.jpg[OpenShift Login page, 95%]
+
.Login
image:oc_login_2.jpg[OpenShift Login page, 95%]



|{counter:srn}|
[.text-justify]
Log in to the Ansible Automation Platform to monitor jobs and triggered events.
|*Action:*
[.text-justify]
.  Go to the Automation Execution (Automation Controller) and click on jobs. Jobs section will show all triggered job templates status by the Event-driven Ansible.
+
image:ac_jobs.jpg[Automation Controller Jobs, 95%]


.  Go to the Automation Decision (Event Driven Aansible) and click on Rulebook Activations . The Rulebook Activations section shows all Rulebook Activations.
+
image:eda_rulebook_activations_v2.png[Event-Driven Ansible Controller Rulebooks, 95%]


|{counter:srn}|
[.text-justify]
Prepare VScode server console to create openshift resources and trigger Event-driven Ansible rulebooks.

|*Action:*
[.text-justify]
.  Go back to the VScode server console and open a terminal.
+
image:vscode_login_terminal.jpg[VScode terminal, 95%]

|{counter:srn}|
[.text-justify]
In order to trigger a set resource quota on a new namespace (rocketchat) by Event-driven ansible event.

[.text-justify]
We goto integrated terminal of vscode server then change to test-events directory. This directory contains three yaml files which contain OpenShift object definition.

[.text-justify]
To trigger set resource quota, we run oc command with 1-test-resource-quota-on-namespace.yml file which creates rocketchat namespace  in  OpenShift. 

[.text-justify]
New namespace creation will eventually trigger a set resource quota event. As an action for the event it will set resource quota on created rocketchat namespace.
 
[.text-justify]
To observe, we can check Automation Decision (Event Driven Aansible) Rulebook Activate and Automation Execution (Automation Controller) jobs.

[.text-justify]
To verify the changes run OpenShift oc command line to check resource quota on created rocketchat namespace. 

|*Action:*
[.text-justify]
.  Go to the vscode integrated terminal, Change the directory and run oc command to create  namespace (rocketchat) which will eventually trigger the event.

+
[source,shell]
----
cd $HOME/demo/test-events/
oc create -f 1-test-resource-quota-on-namespace.yml
----

+
image:eda_vscode_terminal.jpg[VScode terminal, 100%]

*Observe:*
[.text-justify]
. Observe Automation Decision (Event Driven Aansible) Set Resource Quota On Namespace Rulebook Activation has caught the event for new namespace and triggered the action. 



// . Click on Set Resource Quota on Namespace Rulebook Activation.

+
image:eda_trigger_1.jpg[Rulebook Trigger, 95%]

// . Click on History.

// +
// image:eda_trigger_2.jpg[Rulebook Trigger, 95%]

// . Now click on Set Resource Quota on Namespace to view the EDA event logs.
// +
// image:eda_trigger_3.jpg[Rulebook Trigger, 95%]

. Observe the Automation Execution (Automation Controller) has a new job running.
+
image:rq_ac_job.jpg[Automation Controller Job, 95%]


. Observe that the new namespace (rocketchat) has a quota set.  Run the following command on the second terminal. 

+
[source,shell]
----
oc get resourcequota -n rocketchat
----



|{counter:srn}|
[.text-justify]
=== Lab 2 - EDA create volume snapshot on pvc
[.text-justify]
In order to trigger a create volume snapshot of newly added pvc by Event-driven ansible event.

[.text-justify]
We go to the terminal and make sure we are still in the test-events directory which contains three yaml files of OpenShift object definition.

[.text-justify]
To trigger the create volume snapshot, we run oc command with 2-test-volume-snapshot.yml file which creates rocketchat app, database and persistent volume claim in rocketchat namespace.

[.text-justify]
New persistent volume claim creation will eventually trigger a create volume snapshot event. As an action for the event it will create a snapshot of the persistentvolumeclaim in the  rocketchat namespace.
 
[.text-justify]
To observe, we can check Automation Decision (Event Driven Aansible) Rulebook Activate and Automation Execution (Automation Controller) jobs.

[.text-justify]
To verify the changes run OpenShift oc command to get the volume snapshot list in  rocketchat namespace. 

|*Action:*
[.text-justify]
.  Go to the VScode terminal, Change the directory and run oc command to create  the rocketchat application in the rocketchat namespace which will eventually trigger the event.
+
[source,shell]
----
cd $HOME/demo/test-events/
oc create -f 2-test-volume-snapshot.yml
----


*Observe:*
[.text-justify]
.   Observe Automation Decision (Event Driven Aansible) Create Volume Snapshot Rulebook Activation has caught the event for new persistentvolumeclaim which triggered the action.

.  Observe the Automation Execution (Automation Controller) has a new job running.

.  Observe that the new persistentvolumeclaim has a screenshot  in rocketchat namespace.  Run the following command on the second terminal. 
+
[source,shell]
----
oc get volumesnapshot -n rocketchat
----


|{counter:srn}|

[.text-justify]
=== Lab 3 - EDA patch route with cert
[.text-justify]
In order to trigger a patch route of newly added route by Event-driven ansible event.
[.text-justify]
We go to the terminal and make sure we are still in the test-events directory which contains three yaml files of OpenShift object definition.
[.text-justify]
To trigger the patch route, we run oc command with 3-test-route-with-cert.yml file which creates route for rocketchat app in rocketchat namespace.
[.text-justify]
New route creation will eventually trigger a patch route event. As an action for the event it will patch the route with a signed certificate in the  rocketchat namespace.
[.text-justify]
To observe, we can check Automation Decision (Event Driven Aansible) Rulebook Activate history and Automation Execution (Automation Controller) jobs.

[.text-justify]
To verify the changes run OpenShift oc command to get the route in rocketchat namespace. 


|*Action:*
[.text-justify]
.  Go to the VScode terminal, Change the directory and run oc command to create the route for rocketchat application in the rocketchat namespace which will eventually trigger the event.

+
[source,shell]
----
cd $HOME/demo/test-events/
oc create -f 3-test-route-with-cert.yml
----


*Observe:* 
[.text-justify]
. Observe Automation Decision (Event Driven Aansible) Patch Route With Cert Rulebook Activation has caught the event for the new route and triggered the action.

. Observe the Automation Execution (Automation Controller) has a new job running.

. Observe that the new route has been patched  with a certificate.  Run the following command on the terminal.

+
[source,shell]
----
oc get route -n rocketchat -o yaml \| grep cert-manager
----


|{counter:srn}|
[.text-justify]
=== Lab 4 - EDA oc adm inspect
[.text-justify]
我們現在將建立一個新任務，讓 Event-driven Ansible 能夠觸發新的動作。
當發生警告（Warning）或非健康（Unhealthy）事件時，將觸發 EDA 去收集一份 inspect 檔案，以供後續調查使用。

首先必須只定一台機器作為執行oc指令的主機，因此需要在AAP加入此機器的相關設定。


|*Action:*
[.text-justify]
Create a new inventory in Ansible Automation Platform (AAP) to add the machine that will execute the oc commands. 

image:aap_add_inventory.jpg[Create Inventory, 95%]

image:aap_add_inventory2.png[Create Inventory, 95%]

Add host in the inventory

image:https://hackmd.io/_uploads/Hyh6HRf_ee.jpg[]

image:https://hackmd.io/_uploads/B1WhGvtJT.png[]

image:https://hackmd.io/_uploads/H1pIbPY1a.png[]

Create credential for bastion

image:https://hackmd.io/_uploads/BJnZUCzOee.jpgp[]
image:https://hackmd.io/_uploads/SyojI0M_ge.jpg[]

Create Host group in bastion inventory and add bastion to the host group

image:https://hackmd.io/_uploads/BJ175QXdel.png[]
image:https://hackmd.io/_uploads/BJBRDX7Oel.png[]
image:https://hackmd.io/_uploads/BkEm_7m_ex.png[]
image:https://hackmd.io/_uploads/r1SsdX7_ge.png[]
image:https://hackmd.io/_uploads/BkVxtmm_xe.png[]
image:https://hackmd.io/_uploads/HJNWFQQOgg.png[]

|{counter:srn}|
[.text-justify]
接下來我們要加入自定的Playbook，這個Playbook會在事件發生時觸發，並執行oc inspect。蒐集需要的檔案。


|*Action:*
[.text-justify]
Create new playbook for oc adm inspect

image:https://hackmd.io/_uploads/HJkjidtJT.png[]
image:https://hackmd.io/_uploads/Bk6siOt1T.png[]

Clone event-driven-ansible repo in your VScode terminal
[source,shell]
----
cd ~
git clone https://gitea.apps.cluster-7f74v.7f74v.sandbox734.opentlc.com/lab-user/event-driven-ansible.git
----

image:https://hackmd.io/_uploads/B1TgHeXuxx.png[]

Under event-driven-ansible/automation_controller create playbook `oc-inspect.yml`
image:https://hackmd.io/_uploads/ry3mHx7_eg.png[]
填入以下內容
[source,shell]
----
- name: oc adm inspect
  hosts: bastion
  gather_facts: no
  vars:
    ns: "{{ ansible_eda.event.resource.metadata.namespace }}"

  tasks:
    - name: Create inspect file
      shell:
         "oc adm inspect ns/{{ ns }} --kubeconfig /home/lab-user/.kube/config"
      register: lsout
----

push git project
[source,shell]
----
cd ~/event-driven-ansible
git add *
git commit -am "playbook for oc adm inspect"
git push
----

VScode will ask you to login to gittea.
image:https://hackmd.io/_uploads/SkdewgXdlg.png[]


After push completed, Check your commit ID.
image:https://hackmd.io/_uploads/BJ65w0Gdeg.jpg[]

|{counter:srn}|
[.text-justify]
推送新增的腳本後，我們回到AAP的主要頁面，針對剛剛的腳本設定一個新的Job Template。
|*Action:*
[.text-justify]

更新AAP Project

image:https://hackmd.io/_uploads/BkoswCzOlg.jpg[]

新增template取名為 `oc-inspect` 

image:https://hackmd.io/_uploads/S11ydRfOlg.jpg[]

填入對應的內容
image:https://hackmd.io/_uploads/rkOO_CfOee.jpg[]
一定要勾選Prompt on launch，這樣才能在EDA觸發時，帶入變數到playbook內。


|{counter:srn}|
[.text-justify]
完成Template後，我們要設定EDA的Rulebook，讓EDA能夠觸發Job Template。
|*Action:*
[.text-justify]

On Vscode console, switch to eda-rulebooks/rulebooks
and create a file named `oc-inspect.yml`

image:https://hackmd.io/_uploads/rJhIIeQ_ee.png[]


Edit oc-inspect.yml with following 

[source,shell]
----
---
- name: Listen for unhealthy+warning event
  hosts: all
  sources:
    - sabre1041.eda.k8s:
        api_version: v1
        kind: Event
        namespace: eda-demo #自行替換成新預計的ns名稱
  rules:
    - name: Debug
      condition: 
        event.resource.reason == "Unhealthy" and event.resource.type == "Warning"
      throttle:
        once_within: 5 minutes
        group_by_attributes:
          - event.resource.metadata.namespace
          - event.resource.involvedObject.name
      action:
        run_job_template:
          name: oc-inspect #必須對應AAP內的template 名稱
          organization: Default
----

#### Commit and push your rulebook
In the vscode terminal

```bash=
cd ~/eda-rulebooks
git add *
git commit -am "rulebook for oc adm inspect"
git push
```

VScode will ask you to login to gittea.
image:https://hackmd.io/_uploads/SkdewgXdlg.png[]


*Create Rulebook Activcation in AAP*
Sync-Rulebook project again

image:https://hackmd.io/_uploads/rkQ4uemdlg.png[]

Click `Create rulebook activation` 

image:https://hackmd.io/_uploads/BJjWOgQ_ll.png[]

Select and fill like following example
image:https://hackmd.io/_uploads/Bk7qOxmulg.png[]

After that you can see your rule is activated
image:https://hackmd.io/_uploads/r1kndxmOel.png[]


|{counter:srn}|
[.text-justify]
我們可以部屬一個新的應用程式，並故意讓它的健康狀態變成 Unhealthy,這樣就可以觸發 EDA 的 Rulebook。
|*Action:*
[.text-justify]

On you VScode terminal, create a new project and deploy a pod with liveness probe.
```
oc new-project eda-demo
```

```
vim pod-liveness.yml
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-exec
spec:
  containers:
  - name: liveness
    securityContext:
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
        - ALL
    resources:
      requests:
        memory: "64Mi"
        cpu: "250m"
      limits:
        memory: "128Mi"
        cpu: "500m"
    image: k8s.gcr.io/busybox
    args:
    - /bin/sh
    - -c
    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600
    livenessProbe:
      exec:
        command:
        - cat
        - /tmp/healthy
      initialDelaySeconds: 5
      periodSeconds: 5
```

```bash=
oc create -f pod-liveness.yml
```


image:https://hackmd.io/_uploads/ryGBC_typ.png[]

image:https://hackmd.io/_uploads/rkbtCOKy6.png[]


驗證inspect是否成功

image:https://hackmd.io/_uploads/HkHPeYY16.png[]

image:https://hackmd.io/_uploads/SJBulFYJ6.png[]


|{counter:srn}|
[.text-justify]
=== Lab 5 - EDA Gemini AI 分析問題
[.text-justify]
接下來我們要實作透過EDA串接Gemini AI,讓EDA能夠在事件發生時,透過Gemini AI來分析問題。
|*Action:*

[On Bastion or your VScode terminal] Install Gemini-CLI
Install Node.JS
[source,shell]
----
# Download and install nvm:
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh \| bash
# in lieu of restarting the shell
\. "$HOME/.nvm/nvm.sh"
# Download and install Node.js:
nvm install 22

# Verify the Node.js version:
node -v # Should print "v22.17.1".
nvm current # Should print "v22.17.1".

# Verify npm version:
npm -v # Should print "10.9.2".
----

Install Gemini-CLI
[source,shell]
----
npm install -g @google/gemini-cli
----

Get your API-Key
https://aistudio.google.com/app/apikey
image:https://hackmd.io/_uploads/Hk-hX7kPgg.png[]
[source,shell]
----
export GEMINI_API_KEY="<你的API-KEY>"
echo 'export GEMINI_API_KEY="<你的API-KEY>"' >> ~/.bashrc
----

Edit Gemini setting
[source,shell]
----
mkdir .gemini
vi ~/.gemini/settings.json

{
  "theme": "GitHub",
  "mcpServers": {
    "kubernetes": {
      "command": "npx",
      "args": [
        "-y",
        "rh-tam-kubernetes-mcp-server@latest"
      ]
    }
  }
}
----

|{counter:srn}|
[.text-justify]
Bastion安裝完成後,我們要在EDA的Playbook中加入Gemini的API呼叫。讓Gemini能夠在EDA觸發時分析指定namespace的問題。
|*Action:*

於VScode 專案路徑event-driven-ansible/automation_controller底下新增`gemini-analyze.yml`
image:https://hackmd.io/_uploads/HkH_J-QOeg.png[]


[source,shell]
----
- name: Run gemini to troubleshoot given NS
  hosts: bastion
  gather_facts: no
  vars:
    ns: "{{ ansible_eda.event.resource.metadata.namespace }}"

  tasks:
    - name: Gemini analyze NS
      shell: 'gemini -p "分析目前OpenShift內namespace {{ ns }} 有什麼異常 (只需要重點整理，不顯示推論過程)"'
      register: lsout
    - name: Show command output
      debug:
        var: lsout.stdout_lines
----

於Vscode termial
[source,shell]
---
cd ~/event-driven-ansible
git add *
git commit -am "Add gemini_analyze playbook"
git push
---

Resync Templete project
image:https://hackmd.io/_uploads/rJy1Rg7dgl.png[]

Create a new Template called gemini-analyze
image:https://hackmd.io/_uploads/SkO-AeXdxg.png[]

image:https://hackmd.io/_uploads/SkoBlZ7_lx.jpg[]

|{counter:srn}|
[.text-justify]
編寫Rulebook (設定觸發後搜集oc inspect並讓gemini分析問題)
|*Action:*
於VScode 專案路徑eda-ruleboos/ruleboos底下新增`oc-inspce-analyze.yml`
image:https://hackmd.io/_uploads/rkpchxXuel.png[]

[source,shell]
----
---
- name: Listen for unhealthy+warning event
  hosts: all
  sources:
    - sabre1041.eda.k8s:
        api_version: v1
        kind: Event
        namespace: eda-demo #自行替換成新預計的ns名稱
  rules:
    - name: Debug
      condition: 
        event.resource.reason == "Unhealthy" and event.resource.type == "Warning"
      throttle:
        once_within: 5 minutes
        group_by_attributes:
          - event.resource.metadata.namespace
          - event.resource.involvedObject.name
      actions:
        - run_job_template:
            name: oc-inspect #必須對應AAP內的template 名稱
            organization: Default
        - run_job_template:
            name: gemini-analyze
            organization: Default
----


[source,shell]
----
cd ~/eda-rulebooks
git add *
git commit -am "add inspect_analyze rulebook"
git push
----

Sync-Rulebook project again

image:https://hackmd.io/_uploads/rkQ4uemdlg.png[]

Create new rule activecation
image:https://hackmd.io/_uploads/HJt_b-7uxg.png[]

image:https://hackmd.io/_uploads/SkZ0WW7dll.jpg[]

You should see this new rule is activated
image:https://hackmd.io/_uploads/rJs-fWQugg.png[]


Disable the previous role - oc-inspce

image:https://hackmd.io/_uploads/rJn_XbmOgl.png[]
image:https://hackmd.io/_uploads/Bky5XbX_eg.jpg[]


Let's deploy the pod again to trigger the event.
[source,shell]
----
oc delete pod liveness-exec --force

cat << EOF \| oc apply -f -
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-exec
spec:
  containers:
  - name: liveness
    securityContext:
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
        - ALL
    resources:
      requests:
        memory: "64Mi"
        cpu: "250m"
      limits:
        memory: "128Mi"
        cpu: "500m"
    image: k8s.gcr.io/busybox
    args:
    - /bin/sh
    - -c
    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600
    livenessProbe:
      exec:
        command:
        - cat
        - /tmp/healthy
      initialDelaySeconds: 5
      periodSeconds: 5
EOF
----

After a while, you should see the job inspect and gemini-analyze was triggered in a role.
image:https://hackmd.io/_uploads/Sk1pmbQdex.png[]

image:https://hackmd.io/_uploads/BkRzVXQdlg.jpg[]


|{counter:srn}|
[.text-justify]
=== Lab 6 - EDA Gemini AI 總結問題並 create support case
|*Action:*

設定環境 
- 取得 Red Hat API Tokens
- 設定 bastion 環境
[source,shell]
----
echo 'export RH_PORTAL_TOKEN="<你的RH-API-TOKEN>"' >> ~/.bashrc
----

創建 playbook
- 創建 automation_controller/oc-inspect-create-case.yml 
[source,shell]
----
- name: Run gemini to troubleshoot given NS
  hosts: bastion
  gather_facts: no
  vars:
    ns: "{{ ansible_eda.event.resource.metadata.namespace }}"

  tasks:
    - name: Create inspect file
      shell:
         "oc adm inspect ns/{{ ns }} --dest-dir=./inspect.local.{{ ns }} --kubeconfig /home/lab-user/.kube/config"
      register: inspect_file
    - name: Compress with tar
      command: "tar -czf inspect.local.{{ ns }}.tar.gz inspect.local.{{ ns }}"
      when: inspect_file.rc == 0
    - name: Gemini analyze NS
      shell: 'gemini -p "分析目前OpenShift內namespace {{ ns }} 有什麼異常 (只需要單行重點整理，不顯示推論過程)"'
      register: lsout
    - name: Show command output
      debug:
        var: lsout.stdout_lines
    - name: create support case
      shell: 'gemini -p "開一個 OCP support case, 標題是[test case] My pod crashed last night, I was wondering about RCA, 描述為 {{lsout.stdout_lines}}，並且將檔案 inspect.local.{{ ns }}.tar.gz 上傳為附件"'
      register: case_output
    - name: show create case result
      debug:
        var: case_output
----

- sync project 
image:https://hackmd.io/_uploads/BJYDwHmOll.png[]

- create job template
image:https://hackmd.io/_uploads/SJqEPB7_le.png[]

創建 rulebook 

- playbook

[source,shell]
----
vi ~/eda-rulebooks/rulebooks/oc_inspect_support_case.yml

---
- name: Listen for unhealthy+warning event
  hosts: all
  sources:
    - sabre1041.eda.k8s:
        api_version: v1
        kind: Event
        namespace: eda-demo #自行替換成新預計的ns名稱
  rules:
    - name: Debug
      condition: 
        event.resource.reason == "Unhealthy" and event.resource.type == "Warning"
      throttle:
        once_within: 5 minutes
        group_by_attributes:
          - event.resource.metadata.namespace
          - event.resource.involvedObject.name
      actions:
        - run_job_template:
            name: oc-inspect-create-case
            organization: Default
----

- 上傳

[source,shell]
----
cd ~/eda-rulebooks/
git add .
git commit -m "add oc inspect create support case rulebook"
git push
----

- sync project 

image:https://hackmd.io/_uploads/Sk29wBmOge.png[]

- create rulebook activation

image:https://hackmd.io/_uploads/B13kdBmOgg.png[]

測試

[source,shell]
----
oc delete pod liveness-exec --force

cat << EOF \| oc apply -f -
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-exec
spec:
  containers:
  - name: liveness
    securityContext:
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
        - ALL
    resources:
      requests:
        memory: "64Mi"
        cpu: "250m"
      limits:
        memory: "128Mi"
        cpu: "500m"
    image: k8s.gcr.io/busybox
    args:
    - /bin/sh
    - -c
    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600
    livenessProbe:
      exec:
        command:
        - cat
        - /tmp/healthy
      initialDelaySeconds: 5
      periodSeconds: 5
EOF
----

image:https://hackmd.io/_uploads/H1xpbI7dxx.png[]


|====

== Troubleshooting

=== Source Code
* Rulebook/Playbook Repository
** link:https://github.com/redhat-gpte-devopsautomation/demo-event-driven-ansible[Event Driven Ansible Provision Repository]

* Custom Event-Driven Plugin
** link:https://github.com/sabre1041/sabre1041.eda[sabre1041.eda.k8s]

* Decision Environment 
** link:https://github.com/miteshget/eda-de[Build Custom Decision Environment (DE)]

=== Help & Support
* Slack Channel
** link:https://app.slack.com/client/E030G10V24F/C07M6BWRQCF[#event-driven-ansible-with-openshift-demo]



